(function(){window.Helper={Message:{}};Helper.dict={ru:{"New message from":"\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u043e\u0442","Connect to chat":"\u041f\u043e\u0434\u043a\u043b\u044e\u0447\u0438\u043b\u0441\u044f \u043a \u0447\u0430\u0442\u0443","Left this chat":"\u0412\u044b\u0448\u0435\u043b \u0438\u0437 \u0447\u0430\u0442\u0430","Send message":"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435","Current room is not available":"\u0422\u0435\u043a\u0443\u0449\u0438\u0439 \u0447\u0430\u0442 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d",
"Copied to clipboard":"\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440 \u043e\u0431\u043c\u0435\u043d\u0430","Connection error. Try to reload page":"\u041e\u0448\u0438\u0431\u043a\u0430 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443","Something wrong. Connection will be closed":"\u041f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430. \u0421\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043a\u0440\u044b\u0442\u043e"}};
Helper.t=function(a){var b=Cookies.get("chatLang")||"en";return"en"===b?a:Helper.dict[b][a]};Helper.Message.info=function(a){new PNotify({text:a,type:"info",history:!1,icon:!1,styling:"bootstrap3"})};Helper.Message.error=function(a){new PNotify({text:a,type:"error",history:!1,icon:!1,styling:"bootstrap3"})};Helper.uid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})};return Helper})();
(function(){window.Chat={Models:{},Collections:{},Views:{}};Chat.vent=_.extend({},Backbone.Events);Chat.encode=function(a){return a?a.replace(/[\u00A0-\u9999<>]/gim,function(a){return"&#"+a.charCodeAt(0)+";"}):""};Chat.formatTime=function(a){var b=a?new Date(1E3*a):new Date;a=""+b.getHours();b=""+b.getMinutes();return"00".substring(0,2-a.length)+a+":"+"00".substring(0,2-b.length)+b};Chat.makeLink=function(a){a=a.split(" ");for(var b in a)/^https?:\/\//.test(a[b])&&(a[b]='<a href="'+a[b]+'" target="_blank">'+
a[b]+"</a>");return a.join(" ").trim()}})();Chat.Models.User=Backbone.Model.extend({defaults:{username:"",avatar_16:imgPath+"/avatar_16.png",avatar_32:imgPath+"/avatar_32.png",message:""}});Chat.Models.ChatRoom=Backbone.Model.extend({defaults:{id:"",title:""}});Chat.Room=function(a){this.conn=null;this.options=$.extend({url:location.host,port:8080,currentUserId:"",username:""},a);this.active=!1;this.users=new Chat.Collections.Users;this.currentUser=null};
Chat.Room.prototype.init=function(){var a=this;try{if(a.cid=$("#chat-room-list .active").attr("data-chat"),a.cid){a.options.currentUserId||(a.options.currentUserId=Helper.uid(),Cookies.set("chatUserId",a.options.currentUserId));a.conn=new WebSocket("ws"+(location.protocol==="https:"?"s":"")+"://"+a.options.url+":"+a.options.port);a.addConnectionHandlers();var b=setInterval(function(){1==a.conn.readyState&&(a.auth(),clearInterval(b))},200)}else Helper.Message.error(Helper.t("Current room is not available"))}catch(c){Helper.Message.error(Helper.t("Connection error. Try to reload page")),
console.log(c)}a.initLang();a.addEventsHandlers()};Chat.Room.prototype.initLang=function(){var a=navigator.language||navigator.userLanguage,a=a.split("-");Cookies.set("chatLang",a[0],{expires:1})};
Chat.Room.prototype.addEventsHandlers=function(){var a=this;Chat.vent.on("user:auth",function(b){var c=new Chat.Models.User(b.user);"undefined"!==typeof b.join&&b.join?(c.set("message",Helper.t("Connect to chat")),c.set("type","warning"),Chat.vent.trigger("message:add",c)):(a.fillUsers(b.users,b.user),a.currentUser=c,Chat.vent.trigger("user:setCurrent",a.currentUser),Chat.vent.trigger("history:load",b.history));a.users.add(c)});Chat.vent.on("message:send",function(b){a.currentUser.set("message",b);
a.sendMessage(a.currentUser)});Chat.vent.on("user:remove",function(b){b=a.users.get(b.id);b.set({message:Helper.t("Left this chat"),timestamp:""});Chat.vent.trigger("message:add",b);a.users.remove(b)})};
Chat.Room.prototype.addConnectionHandlers=function(){var a=this;a.conn.onclose=function(b){if(a.active&&a.isFunction(a.onClose))a.onClose(b)};a.conn.onerror=function(b){Helper.Message.error("Connection refused");a.conn.close()};a.conn.onmessage=function(b){if(a.isFunction(a.onMessage))a.onMessage(b)};$(window).unload(function(){a.conn.close()})};Chat.Room.prototype.isFunction=function(a){return"function"===typeof a};
Chat.Room.prototype.onMessage=function(a){try{var b=JSON.parse(a.data);switch(b.type){case "auth":Chat.vent.trigger("user:auth",b.data);break;case "message":var c=new Chat.Models.User(b.data.message);c.set("type","info");this.showNotification(c.clone());Chat.vent.trigger("message:add",c);break;case "close":Chat.vent.trigger("user:remove",b.data.user);break;case "error":Helper.Message.error(Helper.t(b.data.message));Cookies.remove('chatUserId');}}catch(d){console.log(d)}};
Chat.Room.prototype.onClose=function(a){console.log("close");console.log(a)};Chat.Room.prototype.sendMessage=function(a){this.send({type:"message",data:{message:a}})};Chat.Room.prototype.auth=function(){var a=new Chat.Models.User({id:this.options.currentUserId,username:this.options.username});this.send({type:"auth",data:{user:a.toJSON(),cid:this.cid}})};Chat.Room.prototype.send=function(a){this.conn.send(JSON.stringify(a))};Chat.Room.prototype.fillUsers=function(a,b){for(var c in a)c!==b.id&&this.users.add(a[c])};
Chat.Room.prototype.showNotification=function(a){var b=this;"Notification"in window&&Notification.requestPermission(function(){var c=Helper.t("New message from")+" "+a.get("name"),d=a.get("message");40<d.length&&(d=d.substring(0,40)+"...");var e=new Notification(c,{icon:a.get("avatar_32"),body:d,lang:b.lang});e.onshow=function(){setTimeout(function(){e.close()},5E3)}})};Chat.Collections.Users=Backbone.Collection.extend({model:Chat.Models.User});Chat.Collections.Rooms=Backbone.Collection.extend({model:Chat.Models.ChatRoom});
Chat.Views.Message=Backbone.View.extend({model:Chat.Models.User,template:"#msg-tpl",render:function(){var a=Chat.makeLink(Chat.encode(this.model.get("message")));this.model.set("timestamp",Chat.formatTime(this.model.get("timestamp")));this.model.set("message",a);this.model.get("type")||this.model.set("type","warning");a=_.template($(this.template).html());this.$el.html(a(this.model.toJSON()));return this}});
Chat.Views.ChatView=Backbone.View.extend({el:".chat-wrapper",events:{"click #send-msg":"sendMessage","keypress #chat-message":"checkKey"},input:"#chat-message",initialize:function(){var a=this;Chat.vent.on("message:add",a.renderMessage,a);Chat.vent.on("user:setCurrent",function(b){a.model=b},a);Chat.vent.on("user:select",a.selectUser,a);Chat.vent.on("history:load",a.loadHistory,a)},renderMessage:function(a){a=new Chat.Views.Message({model:a});var b=this.$el.find(".chat-container");b.append(a.render().el);
b.animate({scrollTop:b[0].scrollHeight},"slow");return this},sendMessage:function(){var a=this.$el.find(this.input),b=a.val();a.val("");b&&(this.model.set("timestamp",""),this.model.set("message",b),this.model.set("type","info"),this.renderMessage(this.model),Chat.vent.trigger("message:send",b))},loadHistory:function(a){for(var b in a){var c=a[b];this.renderMessage(new Chat.Models.User({id:c.user_id,username:c.username,timestamp:c.timestamp,message:c.message,avatar_16:c.avatar_16,avatar_32:c.avatar_32,
type:"info"}))}},checkKey:function(a){13===a.keyCode&&this.sendMessage()},selectUser:function(a){this.model.get("username")!=a&&this.$el.find(this.input).val("@"+a+":")}});
Chat.Views.RoomItemView=Backbone.View.extend({model:Chat.Models.ChatRoom,tagName:"a",className:"list-group-item",template:"#room-tpl",attributes:{target:"_blank"},initialize:function(){this.currentCid=location.search.split("=")[1]||1},render:function(){var a=_.template($(this.template).html());this.$el.html(a(this.model.toJSON()));this.$el.attr({href:location.origin+location.pathname+"?cid="+this.model.get("id"),"data-chat":this.model.get("id")});this.currentCid==this.model.get("id")&&this.$el.addClass("active");
return this}});Chat.Views.AddRoomView=Backbone.View.extend({el:"#add-room-modal",events:{"click #add-room-btn":"add"},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")},add:function(){var a=this.$el.find('[name="title"]').val();a&&(this.hide(),Chat.vent.trigger("chat:add",new Chat.Models.ChatRoom({id:Helper.uid().substring(24),title:a})))}});
Chat.Views.ChatRoomList=Backbone.View.extend({collection:Chat.Collections.Rooms,el:"#chat-room-list",events:{"click #add-chat":"showChatModal","click #exit-chat":"logout"},initialize:function(){this.collection.on("add",this.addRoom,this);Chat.vent.on("chat:add",function(a){this.collection.add(a)},this);this.chatModalView=new Chat.Views.AddRoomView},render:function(){var a=this;a.collection.each(function(b){a.addRoom(b)});return a},addRoom:function(a){a=new Chat.Views.RoomItemView({model:a});this.$el.find(".list-group-container").append(a.render().el)},
showChatModal:function(){this.chatModalView.show()},logout:function(){location.href=location.origin}});
Chat.Views.UserView=Backbone.View.extend({model:Chat.Models.User,template:"#user-tpl",tagName:"a",className:"list-group-item",attributes:{href:"#","data-toggle":"tooltip","data-placement":"right",title:Helper.t("Send message")},events:{click:"selectItem"},initialize:function(){this.model.on("remove",this.remove,this)},render:function(){var a=_.template($(this.template).html());this.$el.html(a(this.model.toJSON()));return this},remove:function(){this.$el.remove()},selectItem:function(a){a.preventDefault();
Chat.vent.trigger("user:select",this.$el.text().trim())}});Chat.Views.AddUserView=Backbone.View.extend({el:"#add-user-modal",events:{"click #add-user-btn":"add"},show:function(){this.$el.modal({backdrop:"static",keyboard:!1})},add:function(){var a=this.$el.find('[name="username"]').val();a&&(this.$el.modal("hide"),Chat.vent.trigger("user:set_username",a))}});
Chat.Views.UserListView=Backbone.View.extend({collection:Chat.Collections.Users,el:"#user-list .list-group-container",initialize:function(){this.collection.on("add",this.renderUser,this)},renderUser:function(a){a=new Chat.Views.UserView({model:a});this.$el.append(a.render().el);return this}});
$(document).ready(function(){var a=new Chat.Collections.Rooms(chatList);(new Chat.Views.ChatRoomList({collection:a})).render();currentUserId=currentUserId||Cookies.get("chatUserId");var b=new Chat.Room({port:port,currentUserId:currentUserId});currentUserId?b.init():((new Chat.Views.AddUserView).show(),Chat.vent.on("user:set_username",function(a){b.options.username=a;b.init()}));new Chat.Views.ChatView;new Chat.Views.UserListView({collection:b.users})});
